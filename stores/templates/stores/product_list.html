{% extends 'base.html' %}

{% block title %}
สินค้าของเรา
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <h1 class="text-4xl font-bold text-gray-800">สินค้าของเรา</h1>

        <form method="GET" action="" class="w-full md:w-96">
            {% if request.GET.category %}
                <input type="hidden" name="category" value="{{ request.GET.category }}">
            {% endif %}

            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400 group-focus-within:text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
                <input type="text" 
                       name="q" 
                       value="{{ request.GET.q|default:'' }}"
                       class="block w-full pl-10 pr-20 py-2.5 border border-gray-300 rounded-full leading-5 bg-gray-50 placeholder-gray-500 focus:outline-none focus:bg-white focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 transition duration-200 sm:text-sm shadow-sm" 
                       placeholder="ค้นหาสินค้า...">
                
                <button type="submit" 
                        class="absolute inset-y-0 right-0 px-5 text-sm font-bold text-white bg-yellow-500 hover:bg-yellow-600 rounded-r-full transition duration-200 focus:outline-none">
                    ค้นหา
                </button>
            </div>
        </form>
    </div>

    <div class="mb-8 overflow-x-auto pb-2">
        <div class="flex space-x-2 min-w-max">
            <a href="?q={{ request.GET.q }}" 
               class="px-5 py-2 rounded-full text-sm font-semibold transition duration-200 border 
               {% if not request.GET.category %}
                   bg-gray-800 text-white border-gray-800 shadow-md
               {% else %}
                   bg-white text-gray-600 border-gray-200 hover:bg-gray-50 hover:border-gray-300
               {% endif %}">
                ทั้งหมด
            </a>

            {% for cat in categories %}
            <a href="?category={{ cat.id }}&q={{ request.GET.q }}" 
               class="px-5 py-2 rounded-full text-sm font-semibold transition duration-200 border whitespace-nowrap
               {% if request.GET.category|stringformat:'s' == cat.id|stringformat:'s' %}
                   bg-yellow-500 text-white border-yellow-500 shadow-md
               {% else %}
                   bg-white text-gray-600 border-gray-200 hover:bg-yellow-50 hover:border-yellow-200 hover:text-yellow-600
               {% endif %}">
                {{ cat.name }}
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-8">
        {% for product in products %}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 hover:shadow-2xl transition duration-300 flex flex-col h-full">

            <a href="{% url 'product_detail' product.id %}" class="block">
                {% if product.image %}
                <div class="w-full h-60 bg-gray-100 flex items-center justify-center overflow-hidden relative group">
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="max-h-full object-contain group-hover:scale-105 transition duration-500">
                </div>
                {% else %}
                <div class="w-full h-60 bg-gray-200 flex items-center justify-center">
                    <span class="text-gray-500">ไม่มีรูปภาพ</span>
                </div>
                {% endif %}
            </a>
            <div class="p-5 flex flex-col flex-grow">
                <div class="flex-grow">
                    <a href="{% url 'product_detail' product.id %}">
                        <h2 class="text-xl font-bold text-gray-800 mb-1 line-clamp-2 hover:text-yellow-600 transition">{{ product.name }}</h2>
                    </a>

                    <div class="flex justify-between items-center mt-4 mb-4">
                        <span class="text-xl font-bold text-yellow-600">{{ product.price }} บาท</span>

                        {% if product.stock > 0 %}
                        <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full whitespace-nowrap">
                            คงเหลือ: {{ product.stock }}
                        </span>
                        {% else %}
                        <span class="text-xs bg-red-100 text-red-700 px-3 py-1 rounded-full whitespace-nowrap">
                            สินค้าหมด
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-auto">
                    {% if product.stock > 0 %}
                    
                    <form id="add-to-cart-form-{{ product.id }}" 
                          action="{% url 'cart:add_to_cart' product_id=product.id %}" 
                          method="POST" 
                          class="mb-2">
                        {% csrf_token %}
                        
                        <div class="flex items-center justify-center space-x-1 border border-gray-300 rounded-lg p-1 w-full max-w-[120px] mx-auto mb-3">
                            <button type="button" 
                                    onclick="updateQuantity('{{ product.id }}', -1)"
                                    class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-red-500 transition duration-150">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                            </button>
                            
                            <input type="number" 
                                   name="quantity" 
                                   id="quantity-{{ product.id }}" 
                                   value="1" 
                                   min="1" 
                                   max="{{ product.stock }}" 
                                   readonly 
                                   class="w-8 h-8 text-center text-gray-800 font-medium border-0 focus:ring-0 p-0 bg-transparent">
                            
                            <button type="button" 
                                    onclick="updateQuantity('{{ product.id }}', 1, '{{ product.stock }}')"
                                    class="w-8 h-8 flex items-center justify-center text-gray-600 hover:text-green-500 transition duration-150">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                        </div>
                        
                        <button type="submit" 
                            class="block w-full text-center bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-bold py-2 rounded-lg text-sm mb-2 shadow-md hover:shadow-lg transition">
                            <svg class="w-5 h-5 inline mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            เพิ่มลงตะกร้า
                        </button>
                    </form>
                    <a href="{% url 'product_checkout' product.id %}"
                        class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm shadow-md hover:shadow-lg transition">
                        ซื้อทันที
                    </a>
                    
                    {% else %}
                    <button class="block w-full text-center bg-gray-200 text-gray-400 font-semibold py-2 rounded-lg text-sm cursor-not-allowed border border-gray-300" disabled>
                        สินค้าหมดชั่วคราว
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-span-1 sm:col-span-2 lg:col-span-5 py-16 text-center bg-gray-50 rounded-xl border border-dashed border-gray-300">
            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
            <p class="text-xl text-gray-500 font-medium">
                {% if request.GET.category %}
                ไม่พบสินค้าในหมวดหมู่นี้
                {% else %}
                ไม่พบสินค้าที่คุณค้นหา
                {% endif %}
            </p>
            <a href="?{% if request.GET.q %}q={{ request.GET.q }}{% endif %}" class="text-yellow-600 hover:underline mt-2 inline-block font-semibold">
                เลือกดูสินค้าหมวดอื่น
            </a>
        </div>
        {% endfor %}
    </div>

</div>

<script>
    function updateQuantity(productId, change, maxStock) {
        const inputField = document.getElementById(`quantity-${productId}`);
        let currentQuantity = parseInt(inputField.value);
        let newQuantity = currentQuantity + change;

        if (newQuantity < 1) {
            newQuantity = 1;
        }
        if (maxStock && newQuantity > maxStock) {
            newQuantity = parseInt(maxStock);
        }

        inputField.value = newQuantity;
    }
</script>
{% endblock %}